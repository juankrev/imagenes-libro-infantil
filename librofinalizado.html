<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Secreto del Abuelo</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Open Sans', sans-serif; }
        h1, .font-fredoka { font-family: 'Fredoka One', cursive; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e0f2f7; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #80DEEA; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #4DD0E1; }
        @keyframes pulse-once { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        .animate-pulse-once { animation: pulse-once 0.5s ease-out; }
        @keyframes scale-in { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes scale-out { from { transform: scale(1); opacity: 1; } to { transform: scale(0); opacity: 0; } }
        .animate-scale-in { animation: scale-in 0.3s ease-out forwards; }
        .animate-scale-out { animation: scale-out 0.3s ease-in forwards; }
        #magnifier-lens {
            width: 150px; height: 150px; border-radius: 50%; border: 4px solid #3b82f6;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); position: absolute; pointer-events: none;
            overflow: hidden; background-repeat: no-repeat; transform: translate(-50%, -50%);
            transition: opacity 0.2s ease-in-out; opacity: 0; background-color: rgba(255, 255, 255, 0.1);
            cursor: none;
        }
        #magnifier-lens.active { opacity: 1; }
        #intro-screen {
            background-image: url('https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20intro.png?raw=true');
            background-size: cover; background-position: center; background-repeat: no-repeat; position: relative;
        }
        #intro-screen::before {
            content: ''; position: absolute; inset: 0; background-color: rgba(0, 0, 0, 0.4);
            border-radius: 2rem; z-index: 0;
        }
        #intro-screen > * { position: relative; z-index: 1; }
        #intro-screen h1, #intro-screen p, #intro-screen label { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        #intro-screen .bg-white { background-color: rgba(255, 255, 255, 0.85); color: #333; }
        #intro-screen .bg-white label { color: #333; text-shadow: none; }
    </style>
    <script type="module">
        // Game state variables
        let userName = '';
        let currentPageIndex = 0;
        let pathTaken = ''; // explorer, historian, guardian

        // The complete story data structure based on the new map
        const storyData = [
            // 0: Intro
            {
                id: 'intro',
                text: 'Bienvenido a "El Secreto del Abuelo". Antes de comenzar, cuéntanos, ¿cómo te llamas?',
                image: '',
            },
            // 1: The Main Choice
            {
                id: 'page1_mapa',
                text: 'El abuelo te recibe. "¡Bienvenido, [userName]! Mi secreto no es una sola cosa, sino tres legados. El camino que elijas definirá tu aventura. ¿Qué quieres explorar?"',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page1_mapa.png?raw=true',
                choices: [
                    { text: 'El Legado del Explorador (Ir al río)', nextPageIndex: 2, path: 'explorer' },
                    { text: 'El Legado del Historiador (Ir a la plaza)', nextPageIndex: 10, path: 'historian' },
                    { text: 'El Legado del Guardián (Ir al sendero oculto)', nextPageIndex: 15, path: 'guardian' }
                ]
            },
            // --- PATH 1: EXPLORER'S LEGACY ---
            { // 2
                id: 'page2_rio',
                text: 'Decides seguir el río, el camino de la aventura. El agua fluye con fuerza. Cerca de la orilla, algo brilla. Es una moneda antigua y pesada.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page12_moneda_antigua.png?raw=true',
                choices: [{ text: 'Seguir el símbolo de la moneda río arriba', nextPageIndex: 3 }]
            },
            { // 3
                id: 'page4_cascada',
                text: 'El símbolo de la moneda te guía hasta una majestuosa cascada. El aire está lleno de bruma. Detrás de la cortina de agua, vislumbras la entrada a una cueva.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page4_cascada.png?raw=true',
                choices: [{ text: 'Entrar en la cueva', nextPageIndex: 4 }]
            },
            { // 4
                id: 'page6_cueva',
                text: 'Dentro de la cueva, encuentras extraños grabados y artefactos. En el centro hay un pedestal con una inscripción: "El sol revela el camino, pero solo la luna te dará la clave." ¿Qué haces?',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20%20page6_cueva.png?raw=true',
                choices: [
                    { text: 'Examinar los artefactos', nextPageIndex: 5 },
                    { text: 'Explorar fuera en busca de una pista', nextPageIndex: 6 }
                ]
            },
            { // 5
                id: 'page_cueva_sin_pista',
                text: 'Los artefactos son fascinantes, pero no parecen hacer nada. Sientes que te falta algo para resolver el misterio del pedestal.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20%20page6_cueva.png?raw=true',
                choices: [{ text: 'Buscar una pista fuera de la cueva', nextPageIndex: 6 }]
            },
            { // 6
                id: 'page7_alrededores_cascada',
                text: 'Explorando los alrededores, encuentras una flor que brilla con una luz plateada. ¡Es una Flor de Luna! Su luz es la clave que necesitabas.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20%20page7_alrededores_cascada.png?raw=true',
                choices: [{ text: 'Volver a la cueva con la flor', nextPageIndex: 7 }]
            },
            { // 7
                id: 'page_cueva_con_pista',
                text: 'Al acercar la Flor de Luna al pedestal, los grabados de la cueva se iluminan, revelando un mapa estelar que señala una colina cercana: ¡la colina del Gran Roble!',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20%20page6_cueva.png?raw=true',
                choices: [{ text: 'Seguir el mapa a la colina', nextPageIndex: 8 }]
            },
            { // 8: Climax del Explorador
                id: 'page10_colina_explorer',
                text: 'Guiado por el mapa estelar, llegas a la colina del Gran Roble. Usando tu instinto de explorador, encuentras un punto donde la tierra parece removida. ¡Excavas y encuentras un cofre!',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20%20page10_colina.png?raw=true',
                choices: [{ text: 'Abrir el cofre del explorador', nextPageIndex: 9 }]
            },
            { // 9: Final del Explorador
                id: 'page33_cofre_explorer',
                text: 'Dentro del cofre hay mapas antiguos, una brújula de latón y el diario de aventuras de tu abuelo. ¡Este es su legado de explorador!',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page33_cofre_revelado.png?raw=true',
                choices: [{ text: 'El abuelo aparece...', nextPageIndex: 30 }]
            },
            // --- PATH 2: HISTORIAN'S LEGACY ---
            { // 10
                id: 'page3_plaza',
                text: 'Te diriges a la plaza, el corazón del pueblo, buscando la sabiduría de sus gentes. Te acercas a una anciana que vende flores.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page3_plaza.png?raw=true',
                choices: [{ text: 'Preguntar a la anciana por el abuelo', nextPageIndex: 11 }]
            },
            { // 11
                id: 'page5_anciana',
                text: 'La anciana sonríe. "Tu abuelo era el guardián de nuestras historias. Me habló del árbol de la vida. ¿Quieres saber sobre sus raíces o sobre sus ramas?"',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page5_anciana.png?raw=true',
                choices: [
                    { text: 'Preguntar por el árbol (las raíces)', nextPageIndex: 12 },
                    { text: 'Preguntar por las ramas (las elecciones)', nextPageIndex: 13 }
                ]
            },
            { // 12
                id: 'page8_arbol_especial',
                text: '"Las raíces de todas las historias del pueblo se encuentran en un lugar", dice la anciana. "El Gran Roble Sabio, en lo alto de la colina. Ve allí si buscas el origen."',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page8_arbol_especial.png?raw=true',
                choices: [{ text: 'Ir a la colina del Gran Roble', nextPageIndex: 14 }]
            },
            { // 13
                id: 'page9_cada_rama',
                text: '"Cada rama es una elección", explica la anciana. "El secreto no es un destino, sino la suma de los caminos. Tu abuelo entendió esto. Su legado está donde todos los caminos del pueblo convergen: el Gran Roble Sabio."',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20%20page9_cada_rama.png?raw=true',
                choices: [{ text: 'Ir a la colina del Gran Roble', nextPageIndex: 14 }]
            },
            { // 14: Climax del Historiador
                id: 'page10_colina_historian',
                text: 'Inspirado por la sabiduría de la anciana, llegas a la colina del Gran Roble. No buscas un tesoro, sino un significado. Y allí, bajo el árbol, como si te esperara, hay un cofre.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20%20page10_colina.png?raw=true',
                choices: [{ text: 'Abrir el cofre del historiador', nextPageIndex: 28 }] // FIX: Corrected nextPageIndex to 28 and removed faulty path property
            },
            // --- PATH 3: GUARDIAN'S LEGACY ---
            { // 15
                id: 'page18_guardian_start',
                text: 'Sigues un sendero oculto. El abuelo te detiene. "Este camino es diferente, [userName]. Es el del Legado del Guardián. Implica proteger la magia del pueblo. ¿Cómo quieres empezar tu entrenamiento?"',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page18_guardian_start.png?raw=true',
                choices: [
                    { text: 'Preguntar por las leyendas', nextPageIndex: 16 },
                    { text: 'Preguntar por el deber del Guardián', nextPageIndex: 17 }
                ]
            },
            { // 16
                id: 'page19_tipo_leyendas',
                text: '"Las leyendas hablan de criaturas y lugares mágicos", dice. "Tu primera prueba: sigue el rastro del Cuco del Silencio. Te llevará al Árbol de la Verdad."',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page19_tipo_leyendas.png?raw=true',
                choices: [{ text: 'Seguir el rastro del Cuco', nextPageIndex: 20 }]
            },
            { // 17
                id: 'page20_implicacion_guardian',
                text: '"Ser un Guardián es mantener el equilibrio. Tu primera prueba está en mi diario. Resuelve el acertijo para demostrar tu valía."',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page20_implicacion_guardian.png?raw=true',
                choices: [{ text: 'Abrir el diario y leer el acertijo', nextPageIndex: 18 }]
            },
            { // 18: Acertijo del Viento
                id: 'page23_diario_primera_prueba',
                text: 'Abres el diario. Lees: "La Primera Prueba: Encuentra lo que siempre está, pero nunca se ve. Lo que susurra sin boca, y se mueve sin pies." ¿Qué es?',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20%20page23_diario_primera_prueba.png?raw=true',
                isRiddle: true, correctAnswers: ['el viento', 'viento'], successPage: 19, failurePage: 24
            },
            { // 19: Éxito acertijo viento
                id: 'page28_acertijo_viento_resuelto',
                text: '¡Correcto! Es el viento. Has superado la primera prueba. El diario revela la siguiente: "Demuestra tu generosidad en el Jardín Escondido."',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page28_acertijo_viento_resuelto.png?raw=true',
                choices: [{ text: 'Ir al Jardín Escondido', nextPageIndex: 22 }]
            },
            { // 20: Camino del Cuco
                id: 'page21_rastro_cuco',
                text: 'Sigues el rastro del ave y llegas a un claro. En el centro, un árbol emite una luz suave. ¡El Árbol de la Verdad!',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page21_rastro_cuco.png?raw=true',
                choices: [{ text: 'Esperar el canto del Cuco', nextPageIndex: 21 }]
            },
            { // 21
                id: 'page25_canto_cuco_verdad',
                text: 'El Cuco canta y tienes una visión: un zorro herido en un jardín. El Árbol de la Verdad te ha mostrado tu siguiente prueba.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page25_canto_cuco_verdad.png?raw=true',
                choices: [{ text: 'Buscar el jardín de la visión', nextPageIndex: 22 }]
            },
            { // 22: Prueba de Generosidad
                id: 'page27_jardin_escondido',
                text: 'Llegas al Jardín Escondido, donde la mágica Flor de los Deseos está a punto de abrirse. Pero un pequeño zorro con la pata herida te mira con tristeza.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page27_jardin_escondido.png?raw=true',
                choices: [
                    { text: 'Ayudar al zorro', nextPageIndex: 23 },
                    { text: 'Ignorar al zorro e ir a por la flor', nextPageIndex: 26 }
                ]
            },
            { // 23: Éxito generosidad
                id: 'page30_ayudar_zorro',
                text: 'Con cuidado, atiendes al zorro. Al hacerlo, la Flor de los Deseos florece por completo, liberando un néctar dorado que te otorga una pieza de un medallón. ¡Has superado la prueba!',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/page30_ayudar_zorro.png?raw=true',
                choices: [{ text: 'Continuar con el entrenamiento', nextPageIndex: 27 }]
            },
            { // 24: Fallo acertijo viento
                id: 'page29_acertijo_viento_fallido',
                text: 'No es la respuesta. El abuelo aparece. "No te preocupes. A veces, la sabiduría no está en acertar, sino en escuchar." Te guía a un viejo pozo.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page29_acertijo_viento_fallido.png?raw=true',
                choices: [{ text: 'Escuchar en el pozo', nextPageIndex: 25 }]
            },
            { // 25
                id: 'page24_abuelo_guia',
                text: 'Del pozo emana un susurro, el Viento Silente, que te cuenta el acertijo de nuevo. Ahora entiendes. "El viento". Has aprendido la lección. El abuelo te envía a tu siguiente prueba: el Jardín Escondido.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page24_abuelo_guia.png?raw=true',
                choices: [{ text: 'Ir al Jardín Escondido', nextPageIndex: 22 }]
            },
            { // 26: Fallo generosidad
                id: 'page31_apartar_zorro',
                text: 'Al ignorar al zorro, la Flor de los Deseos se marchita y el jardín pierde su magia. Has fallado la prueba de la generosidad.',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page31_apartar_zorro.png?raw=true',
                choices: [{ text: 'Aprender de la lección', nextPageIndex: 29 }]
            },
            { // 27: Climax del Guardián
                id: 'page32_reloj_sol_antiguo',
                text: 'Con la prueba final superada, el medallón te guía a un antiguo reloj de sol. Al colocarlo en el centro, el reloj proyecta una luz que revela inscripciones mágicas. ¡Has restaurado un punto de poder!',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page32_reloj_sol_antiguo.png?raw=true',
                choices: [{ text: 'El abuelo aparece...', nextPageIndex: 30 }]
            },
            // --- Shared Pages ---
            { // 28: Final del Historiador (Climax)
                id: 'page33_cofre_historian',
                text: 'Dentro del cofre hay fotos antiguas, cartas y el árbol genealógico de la familia. ¡Este es su legado de historiador!',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page33_cofre_revelado.png?raw=true',
                choices: [{ text: 'El abuelo aparece...', nextPageIndex: 30 }]
            },
            { // 29: Lección Aprendida (Guardian Path)
                id: 'page34_leccion_aprendida',
                text: 'El abuelo aparece. "No has superado la prueba, pero has aprendido algo más valioso: la empatía. Un Guardián debe tener un corazón noble. Vuelve a intentarlo cuando estés listo."',
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20page34_leccion_aprendida.png?raw=true',
                choices: [{ text: 'Volver a empezar el entrenamiento', nextPageIndex: 15 }]
            },
            // 30: Final Page
            {
                id: 'page11_fin_viaje',
                text: '', // Set dynamically
                image: 'https://github.com/juankrev/imagenes-libro-infantil/blob/main/id%20%20page11_fin_viaje.png?raw=true',
                isFinal: true,
                choices: [{ text: 'Volver a jugar', nextPageIndex: 0 }]
            }
        ];

        // DOM element references
        const loadingScreen = document.getElementById('loading-screen');
        const introScreen = document.getElementById('intro-screen');
        const storyScreen = document.getElementById('story-screen');
        const userNameInput = document.getElementById('user-name-input');
        const startStoryBtn = document.getElementById('start-story-btn');
        const storyImage = document.getElementById('story-image');
        const storyText = document.getElementById('story-text');
        const choicesContainer = document.getElementById('choices-container');
        const magnifierLens = document.getElementById('magnifier-lens');
        const magnifierHint = document.getElementById('magnifier-hint');

        function saveProgress() {
            const gameState = { userName, currentPageIndex, pathTaken };
            localStorage.setItem('abueloSecretStoryProgress_v3', JSON.stringify(gameState));
        }

        function loadProgress() {
            const savedProgress = localStorage.getItem('abueloSecretStoryProgress_v3');
            if (savedProgress) {
                const data = JSON.parse(savedProgress);
                userName = data.userName || '';
                currentPageIndex = data.currentPageIndex || 0;
                pathTaken = data.pathTaken || '';
                return true;
            }
            return false;
        }
        
        function preloadImages(urls) {
            urls.forEach(url => { if (url) new Image().src = url; });
        }

        function showScreen(screenElement) {
            loadingScreen.classList.add('hidden');
            introScreen.classList.add('hidden');
            storyScreen.classList.add('hidden');
            screenElement.classList.remove('hidden');
        }

        function renderIntroScreen() {
            userNameInput.value = '';
            showScreen(introScreen);
        }

        function renderStoryPage(pageIndex) {
            const page = storyData[pageIndex];
            if (!page) {
                console.error("Page not found:", pageIndex);
                return renderStoryPage(0);
            }

            currentPageIndex = pageIndex;
            saveProgress();

            // Set final text based on path
            if (page.isFinal) {
                switch(pathTaken) {
                    case 'explorer':
                        page.text = `El abuelo te abraza. "¡Lo has logrado, [userName]! Has seguido las pistas como un verdadero aventurero. Este diario es tu herencia. Ahora eres el **Explorador** de la familia."`;
                        break;
                    case 'historian':
                        page.text = `El abuelo te mira con orgullo. "Has escuchado la sabiduría del pueblo, [userName]. Estas historias son tu legado. Ahora eres el **Historiador** de la familia."`;
                        break;
                    case 'guardian':
                        page.text = `El abuelo pone una mano en tu hombro. "Has demostrado tener valor y un corazón puro, [userName]. Has protegido la magia. Ahora eres el **Guardián** de las Leyendas del pueblo."`;
                        break;
                }
            }
            
            storyText.innerHTML = page.text.replace(/\[userName\]/g, `<span class="font-bold text-indigo-700">${userName}</span>`);
            
            if (page.image) {
                storyImage.src = page.image;
                storyImage.alt = `Imagen de la página: ${page.id}`;
                storyImage.classList.remove('hidden');
                storyImage.classList.add('animate-pulse-once');
                setTimeout(() => storyImage.classList.remove('animate-pulse-once'), 500);
            } else {
                storyImage.src = '';
                storyImage.classList.add('hidden');
            }

            choicesContainer.innerHTML = '';

            if (page.isRiddle) {
                const riddleInput = document.createElement('input');
                riddleInput.type = 'text';
                riddleInput.placeholder = 'Escribe tu respuesta aquí...';
                riddleInput.className = 'w-full max-w-xs px-4 py-2 rounded-lg border-2 border-blue-300 focus:outline-none focus:border-blue-500 transition-all duration-200 text-lg shadow-sm mb-4';
                choicesContainer.appendChild(riddleInput);

                const submitButton = document.createElement('button');
                submitButton.textContent = 'Enviar Respuesta';
                submitButton.className = 'bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-fredoka py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95 mx-2 my-1 border-b-4 border-green-700 text-sm md:text-base';
                
                submitButton.onclick = () => {
                    const answer = riddleInput.value.trim().toLowerCase();
                    renderStoryPage(page.correctAnswers.includes(answer) ? page.successPage : page.failurePage);
                };
                choicesContainer.appendChild(submitButton);
            } else if (page.choices) {
                page.choices.forEach(choice => {
                    const choiceBtn = document.createElement('button');
                    choiceBtn.className = 'bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-fredoka py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95 mx-2 my-1 border-b-4 border-purple-700 hover:border-indigo-800 text-sm md:text-base';
                    choiceBtn.textContent = choice.text;
                    choiceBtn.onclick = () => {
                        if (choice.nextPageIndex === 0) {
                            currentPageIndex = 0;
                            pathTaken = '';
                            userName = '';
                            saveProgress();
                            renderIntroScreen();
                        } else {
                            if (choice.path) pathTaken = choice.path;
                            renderStoryPage(choice.nextPageIndex);
                        }
                    };
                    choicesContainer.appendChild(choiceBtn);
                });
            }
            
            showScreen(storyScreen);
            setupMagnifier(page);
            
            const imagesToPreload = page.choices ? page.choices.map(c => storyData[c.nextPageIndex]?.image).filter(Boolean) : [];
            preloadImages(imagesToPreload);
        }

        function setupMagnifier(page) {
            const storyImageWrapper = storyImage.parentElement;
            let isMagnifying = false;

            storyImageWrapper.onmousedown = storyImageWrapper.onmousemove = storyImageWrapper.onmouseup = storyImageWrapper.onmouseleave = storyImageWrapper.ontouchstart = storyImageWrapper.ontouchmove = storyImageWrapper.ontouchend = null;
            magnifierLens.classList.remove('active');
            magnifierHint.style.display = 'none';

            if (page.image) {
                magnifierHint.style.display = 'block';
                storyImage.onload = () => {
                    const zoomFactor = 1.5;
                    magnifierLens.style.backgroundImage = `url('${page.image}')`;
                    magnifierLens.style.backgroundSize = `${storyImage.naturalWidth * zoomFactor}px ${storyImage.naturalHeight * zoomFactor}px`;

                    const moveMagnifier = (clientX, clientY) => {
                        const imgRect = storyImage.getBoundingClientRect();
                        const wrapperRect = storyImageWrapper.getBoundingClientRect();
                        let x = clientX - imgRect.left;
                        let y = clientY - imgRect.top;
                        magnifierLens.style.left = `${clientX - wrapperRect.left}px`;
                        magnifierLens.style.top = `${clientY - wrapperRect.top}px`;
                        const ratioX = storyImage.naturalWidth / storyImage.offsetWidth;
                        const ratioY = storyImage.naturalHeight / storyImage.offsetHeight;
                        magnifierLens.style.backgroundPosition = `-${x * ratioX * zoomFactor - 75}px -${y * ratioY * zoomFactor - 75}px`;
                    };

                    const startMagnifying = (e) => {
                        isMagnifying = true;
                        magnifierLens.classList.add('active');
                        if (e.touches) e.preventDefault();
                    };
                    const stopMagnifying = () => { isMagnifying = false; magnifierLens.classList.remove('active'); };

                    storyImageWrapper.onmousedown = startMagnifying;
                    storyImageWrapper.onmouseup = stopMagnifying;
                    storyImageWrapper.onmouseleave = stopMagnifying;
                    storyImageWrapper.onmousemove = (e) => { if (isMagnifying) moveMagnifier(e.clientX, e.clientY); };
                    storyImageWrapper.ontouchstart = startMagnifying;
                    storyImageWrapper.ontouchend = stopMagnifying;
                    storyImageWrapper.ontouchmove = (e) => { if (isMagnifying) moveMagnifier(e.touches[0].clientX, e.touches[0].clientY); };
                };
                storyImage.onerror = () => storyImage.src = 'https://placehold.co/600x400/FF0000/FFFFFF?text=Error';
            }
        }

        function alertMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            messageBox.innerHTML = `<div class="bg-gradient-to-br from-yellow-300 to-orange-400 rounded-lg p-6 shadow-2xl max-w-sm w-full text-center relative border-4 border-yellow-500 transform scale-0 animate-scale-in"><p class="text-gray-800 text-xl font-fredoka mb-4">${message}</p><button id="close-message-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">Cerrar</button></div>`;
            document.body.appendChild(messageBox);
            document.getElementById('close-message-btn').onclick = () => {
                const msgBoxInner = messageBox.querySelector('div');
                msgBoxInner.classList.add('animate-scale-out');
                msgBoxInner.addEventListener('animationend', () => document.body.removeChild(messageBox), { once: true });
            };
        }

        window.onload = () => {
            showScreen(loadingScreen);
            if (loadProgress() && userName && currentPageIndex !== 0) {
                renderStoryPage(currentPageIndex);
            } else {
                currentPageIndex = 0;
                pathTaken = '';
                renderIntroScreen();
            }

            startStoryBtn.addEventListener('click', () => {
                userName = userNameInput.value.trim();
                if (userName === '') {
                    return alertMessage('Por favor, ingresa tu nombre para comenzar la aventura.');
                }
                renderStoryPage(1);
            });
        };
    </script>
</head>
<body class="font-sans antialiased bg-gradient-to-br from-blue-200 to-purple-200 flex items-center justify-center min-h-screen p-4 text-gray-800">
    <div id="app" class="relative w-full max-w-3xl bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col items-center justify-center h-screen border-8 border-yellow-400">
        <div id="loading-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-blue-400 to-indigo-500 text-white z-20 rounded-2xl">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
            <p class="text-xl font-semibold font-fredoka">Cargando la aventura...</p>
        </div>
        <div id="intro-screen" class="hidden flex-col items-center justify-center p-8 text-center w-full h-full z-10">
            <h1 class="text-4xl sm:text-5xl font-fredoka text-indigo-700 mb-6 drop-shadow-md leading-tight">¡Tu Aventura en el Pueblo del Abuelo!</h1>
            <p class="text-lg text-gray-700 mb-8 max-w-prose">Antes de iniciar tu viaje, dinos quién eres.</p>
            <div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                <div class="mb-6">
                    <label for="user-name-input" class="block text-gray-700 text-lg font-semibold mb-2">Tu Nombre:</label>
                    <input type="text" id="user-name-input" placeholder="Ej: Sofía o Eiden" class="w-full px-4 py-3 rounded-xl border-2 border-blue-300 focus:outline-none focus:border-blue-500 transition-all duration-200 text-lg shadow-sm">
                </div>
                <button id="start-story-btn" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-fredoka py-4 px-8 rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 active:active:scale-95 focus:outline-none focus:ring-4 focus:ring-green-300 border-b-4 border-green-700">
                    ¡Comenzar la Aventura!
                </button>
            </div>
        </div>
        <div id="story-screen" class="hidden w-full h-full flex flex-col justify-between items-center p-4 sm:p-6 md:p-8 relative">
            <div class="relative w-full aspect-square max-w-[65vh] mx-auto mb-4 rounded-2xl overflow-hidden shadow-xl border-4 border-blue-300 group bg-blue-50">
                <img id="story-image" src="" alt="Imagen de la historia" class="w-full h-full object-contain">
                <div id="magnifier-lens"></div>
                <div id="magnifier-hint" class="absolute bottom-4 right-4 bg-gray-800 bg-opacity-75 text-white text-sm font-semibold px-3 py-2 rounded-lg shadow-lg pointer-events-none">
                    Mantén pulsado para usar la lupa 🔍
                </div>
            </div>
            <div class="w-full bg-blue-50 bg-opacity-95 p-3 sm:p-4 rounded-2xl shadow-inner border border-blue-200 mb-4 text-center h-[20vh] overflow-y-auto custom-scrollbar">
                <p id="story-text" class="text-base md:text-lg leading-relaxed text-gray-800 font-open-sans"></p>
            </div>
            <div id="choices-container" class="flex flex-wrap justify-center gap-2 w-full flex-shrink-0">
            </div>
        </div>
    </div>
</body>
</html>
